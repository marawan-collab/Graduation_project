{% extends "base.html" %}

{% block title %}Radiology Files{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="fas fa-x-ray text-success me-2"></i>Radiology</h2>
    <a href="{{ url_for('patient_medical_records') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Medical Records
    </a>
  </div>

  {% if not folder %}
  <div class="card mb-4">
    <div class="card-header">Create Your Folder</div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('create_radiology_folder') }}">
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label class="form-label">Folder Name</label>
            <input type="text" class="form-control" name="folder_name" placeholder="e.g., Brain_MRI_Oct31" required>
          </div>
          <div class="col-md-4 d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-folder-plus me-2"></i>Create Folder
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-header">My Radiology Files</div>
    <div class="card-body">
      {% if not folder %}
      <div class="row g-3">
        {% if folders and folders|length > 0 %}
          {% for name in folders %}
          <div class="col-md-4">
            <div class="border rounded p-3 h-100 d-flex flex-column justify-content-between position-relative">
              <div>
                <i class="fas fa-folder text-warning me-2"></i><strong>{{ name }}</strong>
              </div>
              {% if secured_folders and name in secured_folders %}
                <img src="{{ url_for('static', filename='images/secure_health_badge.svg') }}" alt="Secured" style="position:absolute; top:8px; right:8px; width:64px; height:auto; opacity:0.95;" />
              {% endif %}
              <div class="mt-3">
                <div class="d-flex flex-column gap-2">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('upload_radiology_in_folder', folder=name) }}">
                    <i class="fas fa-microscope me-1"></i>Open
                  </a>
                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('download_radiology_folder', folder=name) }}">
                    <i class="fas fa-download me-1"></i>Download Folder
                  </a>
                  <form method="POST" action="{{ url_for('delete_radiology_folder', folder=name) }}" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents? This action cannot be undone.');" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger w-100">
                      <i class="fas fa-trash me-1"></i>Delete Folder
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted mb-0">No folders yet. Create one above to start.</p>
        {% endif %}
      </div>
      {% elif folder %}
      <div class="mb-3">
        <form id="folder-upload-form" method="POST" enctype="multipart/form-data" action="{{ url_for('upload_radiology_in_folder', folder=folder) }}">
          <label class="form-label">Scan Radiology Files (Images/PDF)</label>
          <input type="file" class="form-control" name="files" accept="image/*,.pdf" multiple required>
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-success"><i class="fas fa-upload me-2"></i>Scan</button>
            <a href="{{ url_for('patient_radiology_folders') }}" class="btn btn-outline-secondary">Back to Folders</a>
          </div>
        </form>
        
        <!-- Doctor Assignment Form -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-user-md me-2"></i>Assign Doctor (Optional)</h6>
          </div>
          <div class="card-body">
            {% if assigned_doctor %}
            <div class="alert alert-info mb-3">
              <i class="fas fa-info-circle me-2"></i>
              Currently assigned to: <strong>{{ assigned_doctor.name }}</strong>
            </div>
            {% endif %}
            <form method="POST" action="{{ url_for('upload_radiology_in_folder', folder=folder) }}">
              <input type="hidden" name="assign_doctor" value="1">
              <div class="row g-3 align-items-end">
                <div class="col-md-8">
                  <label class="form-label">Select Doctor</label>
                  <select class="form-select" name="assigned_doctor_id">
                    <option value="">-- Select a Doctor (Optional) --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}" {% if assigned_doctor and assigned_doctor.id == doctor.id %}selected{% endif %}>
                      {{ doctor.name }}{% if doctor.specialization %} - {{ doctor.specialization }}{% endif %}
                    </option>
                    {% endfor %}
                  </select>
                  <small class="text-muted">Selecting a doctor will notify them about this radiology folder.</small>
                </div>
                <div class="col-md-4 d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Submit Assignment
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Upload/Checking progress modal -->
        <div class="modal fade" id="uploadProgressModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>Security Check</h5>
              </div>
              <div class="modal-body">
                <div class="mb-2 small text-muted" id="upload-progress-text">Preparing upload…</div>
                <div class="progress">
                  <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          (function(){
            const form = document.getElementById('folder-upload-form');
            if (!form) return;
            form.addEventListener('submit', function(e){
              e.preventDefault();
              const modalEl = document.getElementById('uploadProgressModal');
              const bar = document.getElementById('upload-progress-bar');
              const text = document.getElementById('upload-progress-text');
              const bsModal = new bootstrap.Modal(modalEl, {backdrop: 'static', keyboard: false});
              bsModal.show();
              text.textContent = 'Uploading…';
              bar.style.width = '0%';

              const xhr = new XMLHttpRequest();
              xhr.open('POST', form.action, true);

              xhr.upload.addEventListener('progress', function(ev){
                if (ev.lengthComputable) {
                  const pct = Math.round((ev.loaded / ev.total) * 100);
                  bar.style.width = pct + '%';
                }
              });

              xhr.onreadystatechange = function(){
                if (xhr.readyState === 4) {
                  // Upload finished; server is checking and watermarking
                  text.textContent = 'Checking…';
                  bar.style.width = '100%';
                  // Give the server a brief moment then reload to reflect secured badge
                  setTimeout(function(){
                    window.location.href = window.location.href;
                  }, 500);
                }
              };

              const data = new FormData(form);
              xhr.send(data);
            });
          })();
        </script>
      </div>
      {% if files %}
      <div class="row g-4">
        {% for f in files %}
        <div class="col-12">
          <div class="card border">
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <h5 class="card-title">{{ f.original_filename }}</h5>
                  <p class="text-muted mb-2">
                    <small>
                      <i class="fas fa-calendar me-1"></i>{{ f.uploaded_at.strftime('%Y-%m-%d %H:%M') if f.uploaded_at else 'N/A' }}
                      <span class="ms-3"><i class="fas fa-file me-1"></i>{{ (f.file_type or '').upper() }}</span>
                    </small>
                  </p>
                  
                  {% if f.file_type and f.file_type.lower() in ['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'tif', 'tiff'] %}
                  <div class="mt-3 mb-3 text-center">
                    <img src="{{ url_for('view_radiology', file_id=f.id) }}" 
                         alt="{{ f.original_filename }}" 
                         class="img-fluid rounded border mx-auto d-block"
                         style="max-height: 400px; max-width: 100%;">
                  </div>
                  {% endif %}
                  
                  {% if f.tumor_detected %}
                  <div class="mt-3">
                    {% if f.tumor_detected and f.tumor_detected != 'No Tumor' and f.tumor_detected.lower() not in ['notumor', 'no tumor'] %}
                    <div class="alert alert-danger mb-0">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Tumor Detected</strong>
                      {% if f.confidence %}
                      <br><small class="mt-1 d-block">Confidence: {{ (f.confidence * 100) | round(1) }}%</small>
                      {% endif %}
                      {% if f.analysis_date %}
                      <br><small class="mt-1 d-block text-muted">Analyzed: {{ f.analysis_date.strftime('%Y-%m-%d %H:%M') if f.analysis_date else 'N/A' }}</small>
                      {% endif %}
                      <p class="mb-0 mt-2"><small>Please consult with your doctor for further evaluation and treatment options.</small></p>
                    </div>
                    {% else %}
                    <div class="alert alert-success mb-0">
                      <i class="fas fa-check-circle me-2"></i>
                      <strong>No Tumor Detected</strong>
                      {% if f.confidence %}
                      <br><small class="mt-1 d-block">Confidence: {{ (f.confidence * 100) | round(1) }}%</small>
                      {% endif %}
                      {% if f.analysis_date %}
                      <br><small class="mt-1 d-block text-muted">Analyzed: {{ f.analysis_date.strftime('%Y-%m-%d %H:%M') if f.analysis_date else 'N/A' }}</small>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                <div class="col-md-4 text-end">
                  <div class="d-flex flex-column gap-2">
                    {% if (f.file_type or '').lower() == 'pdf' %}
                    <a class="btn btn-sm btn-primary" href="{{ url_for('view_radiology', file_id=f.id) }}" target="_blank">
                      <i class="fas fa-eye me-1"></i>View PDF
                    </a>
                    {% else %}
                    <a class="btn btn-sm btn-primary" href="{{ url_for('view_radiology', file_id=f.id) }}" target="_blank">
                      <i class="fas fa-eye me-1"></i>View
                    </a>
                    {% endif %}
                    <a class="btn btn-sm btn-secondary" href="{{ url_for('download_radiology', file_id=f.id) }}">
                      <i class="fas fa-download me-1"></i>Download
                    </a>
                    <form method="POST" action="{{ url_for('delete_radiology_file', file_id=f.id) }}" onsubmit="return confirm('Are you sure you want to delete this file? This action cannot be undone.');" class="d-inline">
                      <button type="submit" class="btn btn-sm btn-danger w-100">
                        <i class="fas fa-trash me-1"></i>Delete
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-muted mb-0">No files yet in this folder. Use the Scan button above to upload.</p>
      {% endif %}
      {% else %}
        <p class="text-muted mb-0">Nothing to show.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
